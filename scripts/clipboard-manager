#!/usr/bin/env bash
# =============================================================================
# CLIPBOARD MANAGER - Universal clipboard history
# Works with: cliphist (Wayland), copyq, greenclip, or xclip/xsel (X11)
# Usage: clipboard-manager
# =============================================================================

# Dynamic clipboard tool selection
get_clipboard_tool() {
    if command -v cliphist &>/dev/null && [[ -n "$WAYLAND_DISPLAY" ]]; then
        echo "cliphist"
    elif command -v copyq &>/dev/null; then
        echo "copyq"
    elif command -v greenclip &>/dev/null; then
        echo "greenclip"
    elif command -v xclip &>/dev/null && [[ -n "$DISPLAY" ]]; then
        echo "xclip"
    elif command -v xsel &>/dev/null && [[ -n "$DISPLAY" ]]; then
        echo "xsel"
    else
        echo "none"
    fi
}

CLIPBOARD_TOOL=$(get_clipboard_tool)

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Show notification
notify() {
    local msg="$1"
    if command -v notify-send &>/dev/null; then
        notify-send "Clipboard" "$msg"
    else
        echo -e "${GREEN}$msg${NC}"
    fi
}

# Main clipboard manager function
manage_clipboard() {
    case "$CLIPBOARD_TOOL" in
        "cliphist")
            manage_cliphist
            ;;
        "copyq")
            manage_copyq
            ;;
        "greenclip")
            manage_greenclip
            ;;
        "xclip"|"xsel")
            manage_xclip
            ;;
        "none")
            echo -e "${RED}Error: No clipboard manager found${NC}"
            echo "Install one of: cliphist (Wayland), copyq, greenclip, xclip, xsel"
            exit 1
            ;;
    esac
}

# Manage cliphist (Wayland)
manage_cliphist() {
    if ! command -v rofi &>/dev/null; then
        echo -e "${RED}Error: rofi is required for cliphist integration${NC}"
        exit 1
    fi
    
    local msg='ðŸ‘€ Note: Ctrl+Del = Delete entry | Alt+Del = Clear all'
    
    while true; do
        result=$(
            rofi -i -dmenu \
                -kb-custom-1 "Control-Delete" \
                -kb-custom-2 "Alt-Delete" \
                -config "${HOME}/.config/rofi/config-clipboard.rasi" \
                -mesg "$msg" \
                < <(cliphist list) 2>/dev/null
        )
        
        case "$?" in
            1)
                exit 0
                ;;
            0)
                if [[ -n "$result" ]]; then
                    cliphist decode <<<"$result" | wl-copy
                    notify "Copied to clipboard"
                    exit 0
                fi
                ;;
            10)
                cliphist delete <<<"$result"
                notify "Deleted from history"
                ;;
            11)
                cliphist wipe
                notify "Clipboard history cleared"
                ;;
        esac
    done
}

# Manage copyq
manage_copyq() {
    if command -v rofi &>/dev/null; then
        # Use rofi with copyq
        local items=$(copyq eval 'str(clipboard())' 2>/dev/null | head -20)
        local selected=$(echo "$items" | rofi -dmenu -i -p "ðŸ“‹ Clipboard" -config "${HOME}/.config/rofi/config-clipboard.rasi")
        
        if [[ -n "$selected" ]]; then
            echo "$selected" | copyq copy -
            notify "Copied to clipboard"
        fi
    else
        # Use copyq's native GUI
        copyq toggle
    fi
}

# Manage greenclip
manage_greenclip() {
    if command -v rofi &>/dev/null; then
        local selected=$(greenclip print | rofi -dmenu -i -p "ðŸ“‹ Clipboard" -config "${HOME}/.config/rofi/config-clipboard.rasi")
        
        if [[ -n "$selected" ]]; then
            echo "$selected" | xclip -selection clipboard
            notify "Copied to clipboard"
        fi
    else
        echo -e "${YELLOW}Install rofi for better clipboard management${NC}"
        greenclip print | head -20
    fi
}

# Manage xclip/xsel (X11 fallback)
manage_xclip() {
    echo -e "${YELLOW}Limited clipboard support (install cliphist, copyq, or greenclip for full features)${NC}"
    echo ""
    echo "Current clipboard content:"
    
    if command -v xclip &>/dev/null; then
        xclip -o -selection clipboard 2>/dev/null || echo "(empty)"
    elif command -v xsel &>/dev/null; then
        xsel --clipboard --output 2>/dev/null || echo "(empty)"
    fi
}

# Clear clipboard
clear_clipboard() {
    case "$CLIPBOARD_TOOL" in
        "cliphist")
            cliphist wipe
            ;;
        "copyq")
            copyq clear
            ;;
        "greenclip")
            greenclip clear
            ;;
        "xclip"|"xsel")
            echo "" | xclip -selection clipboard 2>/dev/null || echo "" | xsel --clipboard --input 2>/dev/null
            ;;
    esac
    notify "Clipboard cleared"
}

# Show help
show_help() {
    echo "Clipboard Manager - Universal clipboard history"
    echo ""
    echo "Usage: clipboard-manager [options]"
    echo ""
    echo "Options:"
    echo "  -c, --clear    Clear clipboard history"
    echo "  -h, --help     Show this help message"
    echo ""
    echo "Current backend: $CLIPBOARD_TOOL"
    echo ""
    echo "Supported backends:"
    echo "  â€¢ cliphist - Modern Wayland clipboard manager"
    echo "  â€¢ copyq    - Advanced clipboard manager with GUI"
    echo "  â€¢ greenclip- Simple clipboard manager for rofi"
    echo "  â€¢ xclip    - Basic X11 clipboard (fallback)"
    echo "  â€¢ xsel     - Basic X11 selection (fallback)"
}

# Parse arguments
case "${1:-}" in
    -c|--clear)
        clear_clipboard
        ;;
    -h|--help)
        show_help
        ;;
    *)
        manage_clipboard
        ;;
esac